<script type="text/babel">
$(document).ready(init_js)

function init_js(){
  formValidation()
  loadAcademicProgramsAndFaculties()
  $('.ui.radio.checkbox').checkbox()
  $('select.dropdown').dropdown()
  $('.numeric').on('keypress', function (e) {
    return e.metaKey || // cmd/ctrl
    e.which <= 0 || // arrow keys
    e.which == 8 || // delete key
    /[0-9]/.test(String.fromCharCode(e.which)); // numbers
  });

  $('#busca-cedula').on('keyup', function(event){
    event.preventDefault();
    // Number 13 is the "Enter" key on the keyboard
    if (event.keyCode === 13) {
      // Trigger the button element with a click
      document.getElementById("btn-search").click();
    }
  })

}

function validationpassed(e) {
  e.preventDefault()
  var mForm = $('.ui.form')
  var formData = mForm.serializeArray()


  function onSuccess(response) {
    console.log('RESPONSE', response)
    if (response.ok) {
      disableFormFielfds(false)
      $('.ui.form').form('clear')
    }else{
      console.log('You fucked up', response)
    }
  }

  console.log(formData)
  google.script.run.withSuccessHandler(onSuccess).registerPerson(formData)
}

function searchForPerson() {
  hideForm()
  $('#btn-search').addClass('loading')

  function onSuccess(person) {
    if(person){
      showForm()
      console.log('A nice formatted person', person)
      $('#btn-search').removeClass('loading')
      if (person.isRegistered) {
        loadPersonInForm(person)
      }else{
        var sraPerson = searchPersonInSRA()
        if(sraPerson){
          loadSRAPersonInForm(sraPerson)
        }
      }
    }else{
      console.log('Something went wrong searching user...')
    }
  }

  var cedula = $('#busca-cedula').val()
  if(cedula.length>0){
    google.script.run.withSuccessHandler(onSuccess).searchPerson(cedula)
  }else{
    $('#btn-search').removeClass('loading')
    $("#search-msg").html('Por favor ingrese una cedula')
    $("#search-msg").css('display','block')
  }
}

function disableFormFielfds(bool){
  if(bool){
    $("input:not([name='busca-cedula'])").prop('disabled', true)
  }else{
    $("input:not([name='busca-cedula'])").prop('disabled', false)
  }
}
var normalize = (function() {
  var from = "ÃÀÁÄÂÈÉËÊÌÍÏÎÒÓÖÔÙÚÜÛãàáäâèéëêìíïîòóöôùúüûÑñÇç",
      to   = "AAAAAEEEEIIIIOOOOUUUUaaaaaeeeeiiiioooouuuunncc",
      mapping = {};

  for(var i = 0, j = from.length; i < j; i++ )
      mapping[ from.charAt( i ) ] = to.charAt( i );

  return function( str ) {
      var ret = [];
      for( var i = 0, j = str.length; i < j; i++ ) {
          var c = str.charAt( i );
          if( mapping.hasOwnProperty( str.charAt( i ) ) )
              ret.push( mapping[ c ] );
          else
              ret.push( c );
      }
      return ret.join( '' );
  }

})();

function loadSRAPersonInForm(person){
  console.log('Person in form', person)
  var full_name = person.nombre.split(" ");

  $("input[name='nombres']").val(full_name[2]+ ' ' + (full_name[3]!=null? full_name[3]:''))
  $("input[name='apellidos']").val(full_name[0] + ' '+full_name[1])
  $("input[name='cedula']").prop('disabled',true)
  $("input[name='nombres']").prop('disabled',true)
  $("input[name='apellidos']").prop('disabled',true)

  if(person.titulo){
    function onSuccess(result){
      if(result){
        $.each(result.programs, function (i, program) {
          if(normalize(person.titulo).includes(String(program["titulo_otorgado"]))>0){
            $("select[name='programa']").dropdown('set selected', program.nombre)
            $(".dropdown").dropdown()
            $(".ui.dropdown").addClass('disabled')
          }
        });
      }
    }
    google.script.run.withSuccessHandler(onSuccess).getFacultiesAndPrograms()
  }
}

function loadPersonInForm(person) {
  console.log('Person in form', person)

  $("input[name='nombres']").val(person.data.nombres)
  $("input[name='apellidos']").val(person.data.apellidos)
  $("input[name='cedula']").val(person.data.cedula)
  $("input[name='correo']").val(person.data.correo)
  $("input[name='celular']").val(person.data.celular)
  $("select[name='programa']").dropdown('set selected',person.data.programa)
  $("select[name='programa']").addClass('disabled')
  $("select[name='facultad']").dropdown('set selected', person.data.facultad)
  $("select[name='facultad']").addClass('disabled')

  disableFormFielfds(true)
}


function showForm() {
  $('#mainForm').css('display', 'block')
  $("input[name='cedula']").val($("#busca-cedula").val())
  disableFormFielfds(false)
}

function hideForm() {
  $('#mainForm').css('display', 'none')
  disableFormFielfds(false)
  $('.ui.form').form('clear')

}
function loadAcademicProgramsAndFaculties() {

  function onSuccess(result) {
    console.log('good job', result)
    if(result){
      $.each(result.programs, function (i, program) {
        $("select[name='programa']").append($('<option>', {
          value: program.nombre,
          text : program.nombre
        }));
      });

      $.each(result.faculties, function (i, faculty) {
        $("select[name='facultad']").append($('<option>', {
          value: faculty,
          text : faculty
        }));
      });

      $("select[name='programa']").on('change', function(e){
        $.each(result.programs, function (i, program) {
          if(e.target.value == program.nombre){
            $("select[name='facultad']").val(program.facultad)
            $("select[name='facultad']").trigger('change')
            return false
          }
        });
      })
    }
  }
  google.script.run.withSuccessHandler(onSuccess).getFacultiesAndPrograms()
}

function searchPersonInSRA(cedula){

  // fetch('https://arzayus.co/egresados-script.php',{
  //   method:'post',
  //   body:`cedula=${cedula}`,
  //   headers:{
  //     'Content-Type': 'application/x-www-form-urlencoded'
  //   }
  // }).then(function(response) {
  //   return response.json();
  // }).then(function(data) {
  //   console.log('Created Gist:', data);
  //   if(data){
  //     return {
  //       "nombre": "RAMIREZ TORRES SAMUEL",
  //       "titulo": "TECNÓLOGO EN SISTEMAS DE INFORMACIÓN "
  //     };
  //   }else return null;
  // });
  return {
    "nombre": "ABONIA GONZALEZ RODRIGO",
    "titulo": "TECNOLOGO ESPECIALIZADO EN QUIMICA CON ENFASIS EN TECNICAS MODERNAS DE ANALISIS INSTRUMENTAL"
  };
}

function formValidation() {
  $('.ui.form')
  .form({
    inline: true,
    on: 'blur',
    transition: 'fade down',
    onSuccess: validationpassed,
    fields: {
      nombres: {
        identifier: 'nombres',
        rules: [
          {
            type: 'empty',
            prompt: 'Por favor ingrese un nombre'
          }
        ]
      },
      apellidos: {
        identifier: 'apellidos',
        rules: [
          {
            type: 'empty',
            prompt: 'Por favor ingrese un apellido'
          }
        ]
      },
      cedula: {
        identifier: 'cedula',
        rules: [
          {
            type: 'number',
            prompt: 'Por favor ingrese una cedula valido'
          },
          {
            type: 'empty',
            prompt: 'Por favor ingrese una cedula'
          }
        ]
      },
      celular: {
        identifier: 'celular',
        rules: [
          {
            type: 'number',
            prompt: 'Por favor ingrese un numero valido'
          },
          {
            type: 'empty',
            prompt: 'Por favor ingrese un numero'
          }
        ]
      },
      email: {
        identifier: 'correo',
        rules: [
          {
            type: 'email',
            prompt: 'Por favor ingrese a correo valido'
          },
          {
            type: 'empty',
            prompt: 'Por favor ingrese un correo'
          }
        ]
      },
      programa: {
        identifier: 'programa',
        rules: [
          {
            type: 'empty',
            prompt: 'Por favor ingrese un programa'
          }
        ]
      },

      // expedicion: {
      //   identifier: 'expedicion',
      //   rules: [
      //     {
      //       type: 'empty',
      //       prompt: 'Por favor ingrese una expedicion'
      //     }
      //   ]
      // },
      facultad: {
        identifier: 'facultad',
        rules: [
          {
            type: 'empty',
            prompt: 'Por favor ingrese una facultad'
          }
        ]
      },
    }
  })
}




</script>
